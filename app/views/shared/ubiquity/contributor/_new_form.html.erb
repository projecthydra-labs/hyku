<% template = f.object.model.class.to_s.underscore %>


<div class="ubiquity-meta-contributor" >

  <label class="control-label multi_value optional" for="#{template}_contributor_name_type">
    Contributor name type</label>

  <%= select_tag "#{template}[contributor_group][][contributor_name_type]", content_tag(:option,'select one...',:value=>"")+options_from_collection_for_select( NameTypeService.new.select_active_options.flatten.uniq!, :to_s, :to_s, 'Personal'), class: "ubiquity_contributor_name_type" %>

  <p class="help-block">A person or group you want to recognise for playing a role in the creation of the work, but not the primary role.</p>

  <label class="control-label multi_value optional" for="#{template}_contributor_isni">
    Contributor ISNI</label>

  <%= text_field_tag "#{template}[contributor_group][][contributor_isni]", nil,
                     class: "#{template}_contributor_group form-control multi-text-field multi_value ubiquity_contributor_isni",
                     placeholder: 'Please enter the contributor\'s ISNI, e.g. 0000 1234 5678 9101.',
                     name: "#{template}[contributor_group][][contributor_isni]"
  %>

  <br/>

  <label class="ubiquity_contributor_organization_name control-label multi_value optional" for="#{template}_contributor_organization_name">
    Contributor organisation name</label>

  <%= text_field_tag "#{template}[contributor_group][][contributor_organization_name]", nil,
                     class: "ubiquity_contributor_organization_name #{template}_contributor_organization_name form-control multi-text-field multi_value ubiquity_contributor_organisation_name_text_field",
                     placeholder: 'Please enter the organisation\'s name.',
                     name: "#{template}[contributor_group][][contributor_organization_name]"
  %>

  <span class="ubiquity_personal_fields">

    <label class="control-label multi_value optional" for="#{template}_contributor_orcid">
      Contributor ORCID</label>

    <%= text_field_tag "#{template}[contributor_group][][contributor_orcid]", nil,
                       class: "#{template}_contributor_group form-control multi-text-field multi_value ubiquity_contributor_orcid",
                       placeholder: 'Please enter the contributor\'s ORCID, e.g. 0000-1234-5678-9101.',
                       name: "#{template}[contributor_group][][contributor_orcid]"
    %>
    <br/>

    <label class="control-label multi_value optional" for="#{template}_contributor_family_name">
      Contributor family name</label>

    <%= text_field_tag "#{template}[contributor_group][][contributor_family_name]", nil,
                       class: "#{template}_contributor_family_name form-control multi-text-field multi_value ubiquity_contributor_family_name",
                       placeholder: 'Please enter the contributor\'s last name/family name.',
                       name: "#{template}[contributor_group][][contributor_family_name]"
    %>
    <br/>

    <label class="control-label multi_value optional" for="#{template}_contributor_given_name">
      Contributor given name</label>

    <%= text_field_tag "#{template}[contributor_group][][contributor_given_name]", nil,
                       class: "#{template}_contributor_given_name form-control multi-text-field multi_value ubiquity_contributor_given_name",
                       placeholder: 'Please enter the contributor\'s first name/given name.',
                       name: "#{template}[contributor_group][][contributor_given_name]"
    %>

    <br/>
    <label class="control-label multi_value optional" for="#{template}_contributor_institutional_relationship">
      Contributor institutional relationship  </label>
    <%= select_tag "#{template}[contributor_group][][contributor_institutional_relationship][]", content_tag(:option,'select one...',:value=>"")+options_from_collection_for_select( ['Staff member', 'Research associate'], :to_s, :to_s),
       multiple: true, class: "form-control"  %>

  </span>  <!-- closes ubiquity_personal_fields -->
  <br/>
  <label class="control-label multi_value optional" for="#{template}_contributor_type">
    Contributor Role</label>
  <%= select_tag "#{template}[contributor_group][][contributor_type]",
                 content_tag(:option,'select one...',:value=>"")+options_from_collection_for_select( ContributorGroupService.new.select_active_options.flatten.uniq!, :to_s, :to_s)
  %>
  <br/><br/>

  <%= hidden_field_tag "#{template}[contributor_group][][contributor_position]", 1, class: 'ubiquity-contributor-score'  %>

  <a href="#" style="color:red;"  class=" remove_contributor form-group " data-removeUbiquitycontributor=".ubiquity-meta-contributor">
    <span class="glyphicon glyphicon-remove"></span>
    <span class="controls-remove-text">Remove</span>
  </a>
  |
  <a href="#" class=" add_contributor" data-addUbiquitycontributor=".ubiquity-meta-contributor">Add another </a>

  <br/><br/><br/>

</div>
<script>
$(document).on("turbolinks:load", function(){
  $('.ubiquity_contributor_orcid, .ubiquity_contributor_isni').focusout(function(){
    var check_for_name = ($('.ubiquity_contributor_orcid').val() != '') || ($('.ubiquity_contributor_isni').val() != '');
    var drop_down_val = $('.ubiquity_contributor_name_type').val();
    var check_for_isni_value = $('.ubiquity_contributor_isni').val();
    var check_for_org_value = $('.ubiquity_contributor_organisation_name_text_field').val();
    if ((drop_down_val == 'Organisational') && (check_for_org_value == '') && (check_for_isni_value != '')) {
      addOrganisationNameMandatory();
    }
    else if (check_for_name) {
      var check_for_value = ($('.ubiquity_contributor_family_name').val() != '') || ($('.ubiquity_contributor_given_name').val() != '');
      if (check_for_value == false){
        addFieldsNamesMandatory();
      }
    }
    else{
      removeFieldsNamesFromMandatory();
    }
  })

  $('.ubiquity_contributor_family_name, .ubiquity_contributor_given_name, .ubiquity_contributor_organisation_name_text_field').focusout(function(){
    if (($('.ubiquity_contributor_given_name').val() != '') && $('.ubiquity_contributor_given_name').is(":visible")) {
      removeFieldsNamesFromMandatory();
    }
    else if (($('.ubiquity_contributor_family_name').val() != '') && $('.ubiquity_contributor_family_name').is(":visible")) {
      removeFieldsNamesFromMandatory();
    }
    else if (($('.ubiquity_contributor_organisation_name_text_field').val() != '') && $('.ubiquity_contributor_organisation_name_text_field').is(":visible")) {
      removeFieldsNamesFromMandatory();
    }
    else if (($('.ubiquity_contributor_orcid').val() != '') || ($('.ubiquity_contributor_isni').val() != '')) {
      addFieldsNamesMandatory();
    }
  })

  $('.ubiquity_contributor_name_type').change(function(){
    // When it changes the drop down value of the creater type
    $('.ubiquity_contributor_orcid').trigger('focusout');
    if (this.value == 'Personal') {
      var check_for_name = ($('.ubiquity_contributor_given_name').val() != '') || ($('.ubiquity_contributor_family_name').val() != '');
      if ($('.ubiquity_contributor_isni').val() != '' && check_for_name == false) {
        addFieldsNamesMandatory();
      }
      else{
        removeFieldsNamesFromMandatory();
      }
    }
    else{
      var check_for_org_value = $('.ubiquity_contributor_organisation_name_text_field').val();
      if ($('.ubiquity_contributor_isni').val() != '' && check_for_org_value == '') {
        addFieldsNamesMandatory();
      }
      else{
        removeFieldsNamesFromMandatory();
      }
    }
  });

});

function removeFieldsNamesFromMandatory() {
  $('.ubiquity_contributor_family_name').prop('required', false)
  $('.ubiquity_contributor_family_name').css('border-color', '#ccc');
  $('.ubiquity_contributor_given_name').prop('required', false);
  $('.ubiquity_contributor_given_name').css('border-color', '#ccc');
  $('.ubiquity_contributor_organisation_name_text_field').prop('required', false);
  $('.ubiquity_contributor_organisation_name_text_field').css('border-color', '#ccc');
}

function addFieldsNamesMandatory() {
  $('.ubiquity_contributor_family_name').prop('required', true);
  $('.ubiquity_contributor_family_name').css('border-color', 'red');
  $('.ubiquity_contributor_given_name').prop('required', true);
  $('.ubiquity_contributor_given_name').css('border-color', 'red');
  $('.ubiquity_contributor_organisation_name_text_field').prop('required', true);
  $('.ubiquity_contributor_organisation_name_text_field').css('border-color', 'red');
}

function addOrganisationNameMandatory(){
  $('.ubiquity_contributor_organisation_name_text_field').prop('required', true);
  $('.ubiquity_contributor_organisation_name_text_field').css('border-color', 'red');
}
</script>